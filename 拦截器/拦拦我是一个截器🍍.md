# æ‹¦æ‹¦æˆ‘æ˜¯ä¸€ä¸ªæˆªå™¨ğŸ

> ä¸šåŠ¡å¼€å‘ä¸­ï¼Œé¿å…ä¸äº†è¦ä¸åç«¯æ¥å£æ‰“äº¤é“ã€‚

## 0âƒ£ï¸ è¿™é‡Œå…ˆæå‡ºå‡ ä¸ªé—®é¢˜ï¼š

1. æ˜¯å¦å¯ä»¥å¯¹åç«¯æ¥å£è¿”å›çš„æ•°æ®è¿›è¡Œ**ç»Ÿä¸€å¤„ç†**ï¼Ÿ

2. æ¥å£è¯·æ±‚å¼‚å¸¸æ€ä¹ˆå¤„ç†ï¼Œæ¯”å¦‚ï¼šæ¥å£è¯·æ±‚è¶…æ—¶ï¼Ÿ

## 1âƒ£ï¸ æ¥å£çš„ç»Ÿä¸€å¤„ç†

> æˆ‘ä»¬é€šå¸¸ä½¿ç”¨axiosæ¥å‘é€æ¥å—è¯·æ±‚ï¼Œè€Œaxiosä¸ºæˆ‘ä»¬æä¾›ä¼˜ç§€ä¾¿æ·çš„**æ‹¦æˆªå™¨**ï¼Œä¾¿äºæˆ‘ä»¬å¯¹**å‘é€çš„è¯·æ±‚**å’Œ**æ¥å—åˆ°çš„è¿”å›ç»“æœ**è¿›è¡Œç»Ÿä¸€å¤„ç†ã€‚

### 1.1 axioså‘é€çš„è¯·æ±‚å¤„ç†

> 1ã€å¯ä»¥é‡å®šä¹‰axiosçš„getè¯·æ±‚æ–¹å¼çš„å‚æ•°åã€‚</br>
> 2ã€å¯ä»¥ç»Ÿä¸€å®šä¹‰å¤„ç†ä¸åŒè¯·æ±‚æ–¹å¼ä¸‹ï¼Œä¼ ç»™æœåŠ¡å™¨çš„å†…å®¹æ ¼å¼ã€‚

``` js
    const instance = axios.create();

    instance.defaults.withCredentials = true; // å¸¦ä¸Šcookie

    // è¯·æ±‚çš„æ‹¦æˆªå™¨
    instance.interceptors.request.use(function (config) {
        if (config.method === 'get' && config.data && !config.params) {
            // 1ã€å†™æ¥å£æ—¶ï¼Œæ— è®ºget/postï¼Œå‚æ•°ç»Ÿä¸€ç”¨data ï¼ˆæ‡’å¾—åŒºåˆ†ï¼Œå¯èƒ½ä¹Ÿæ²¡æœ‰ä»€ä¹ˆç”¨ğŸ˜·ï¼‰
            // è¯·æ±‚æ—¶ï¼Œåœ¨å°†getçš„å‚æ•°èµ‹å€¼ç»™params
            config.params = config.data;
        } else if (config.method === 'post' && config.data) {
            // 2ã€æœ‰æ—¶postè¯·æ±‚æ–¹å¼ï¼Œåç«¯æ¥å—çš„æ ¼å¼æ˜¯FormDataï¼ˆå› åç«¯æ¥å£è€Œå¼‚ï¼‰
            let formData = new FormData();
            Object.keys(config.data).forEach((key) => {
                formData.append(key, config.data[key]);
            });
            config.data = formData;
            config.headers = {'Content-Type': 'multipart/form-data'};
        }
        return config;
    }, function (error) {
        return Promise.reject(error);
    });
```

### 1.2 axiosæ¥å—åˆ°çš„è¿”å›ç»“æœå¤„ç†

``` js
    // æ¥å—çš„æ‹¦æˆªå™¨
    instance.interceptors.response.use(function (response) {
        // æ­£å¸¸
        return response;
    }, function (error) {
        // å¼‚å¸¸
        return Promise.reject(error);
    });
```

### 1.3 å‘é€çš„è¯·æ±‚å’Œæ¥å—åˆ°çš„ç»“æœè¿›ä¸€æ­¥å¤„ç†

> 1ã€å¯ä»¥æ ¹æ®æœåŠ¡å™¨è¿”å›çš„codeè¿›è¡Œä¸åŒçš„å¤„ç†ã€‚

- ä¸€èˆ¬æ¥å£è¯·æ±‚æˆåŠŸï¼Œåç«¯ä¼šè¿”å›codeï¼š200ï¼ˆcodeçš„å€¼éœ€è¦å‰åç«¯ä¸€èµ·å®šä¹‰ï¼‰ã€‚
- æ³¨æ„ï¼šç™»å…¥è¶…æ—¶codeä¼šè¿”å›10001ï¼Œä½†æ­¤æ—¶æ¥å£è¿˜æ˜¯è¯·æ±‚æˆåŠŸçš„ï¼ˆæ ¹æ®successï¼štrueå¾—çŸ¥ï¼‰ï¼Œæ­¤æ—¶æˆ‘ä»¬å¯ä»¥å¼•å¯¼ç”¨æˆ·é‡æ–°ç™»é™†ï¼ˆâœï¸ï¼šæœ‰æ—¶tokenè¿‡æœŸï¼Œæˆ‘ä»¬å¯ä»¥è‡ªåŠ¨é‡æ–°è·å–tokenï¼‰ã€‚
- codeåŸæœ¬æ˜¯æ²¡æœ‰æ„ä¹‰çš„ï¼Œä½†æ˜¯é€šè¿‡å‰åç«¯çš„æå‰å®šä¹‰ä½¿å…¶å˜å¾—æœ‰æ„ä¹‰ã€‚

> 2ã€åˆ¤æ–­æ¥å—åˆ°çš„ç»“æœæ˜¯å¦æ˜¯å¼‚å¸¸æµï¼Œæ›´å¥½çš„æ–¹æ³•åº”è¯¥æ˜¯é€šè¿‡åˆ¤æ–­successçš„å€¼ã€‚</br>
> 3ã€æˆ‘ä»¬å¯ä»¥é€šè¿‡codeå€¼æ¥åŒºåˆ†æ˜¯å‰ç«¯æ“ä½œä¸å½“å¯¼è‡´æŠ¥é”™ï¼Œè¿˜æ˜¯å› ä¸ºåç«¯æ“ä½œä¸å½“å¯¼è‡´æŠ¥é”™ã€‚

- å‰ç«¯æ“ä½œä¸å½“ï¼šç¼ºå°‘å‚æ•°ã€å‚æ•°æ ¼å¼ä¸å¯¹ç­‰ã€‚æ­¤æ—¶ï¼Œåº”è¯¥æç¤ºç”¨æˆ·å…·ä½“åŸå› ã€‚
- åç«¯æ“ä½œä¸å½“ï¼šæ•°æ®åº“æŸ¥è¯¢å´©äº†ç­‰ã€‚æ­¤æ—¶ï¼Œå°±åªéœ€å‘Šè¯‰ç”¨æˆ·æ˜¯ç³»ç»Ÿé”™è¯¯å³å¯ï¼ˆä»–ä»¬ä¸éœ€è¦çŸ¥é“å¤ªå¤šï½who careï¼‰ã€‚
- å‰åç«¯çš„æ“ä½œä¸å½“ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡Promise.rejectè¿”å›ä¸åŒæ ¼å¼çš„å€¼ã€‚å‰ç«¯ä¸å½“è¿”å›æ­£å¸¸error Objectï¼Œåç«¯ä¸å½“è¿”å› Error æ ¼å¼é”™è¯¯ã€‚

``` js
    const resolveResponse = ({config, response}) => {
        let loginTimeout = parseInt(response.data.code) === 10001; // æ˜¯å¦ç™»é™†è¶…æ—¶
        let apiIsSuccess = parseInt(response.data.code) === 200; // æ˜¯å¦æ˜¯åå°çš„ç³»ç»Ÿé”™è¯¯ï¼ˆæ³¨æ„ï¼šè¦å’Œåå°çº¦å®šï¼Œæ˜¯å‰ç«¯ä¼ çš„å‚æ•°çš„å¯¼è‡´æ²¡æœ‰æ•°æ®ï¼Œcodeè¿”å›200ï¼‰
        let returnDataSuccess = response.data.success; // æ˜¯å¦æ˜¯å¼‚å¸¸æµ

        if (loginTimeout) {
            // ç™»å½•è¶…æ—¶,è¯·åˆ·æ–°é¡µé¢é‡æ–°ç™»å½•
            console.error('ç™»å½•è¶…æ—¶,è¯·åˆ·æ–°é¡µé¢é‡æ–°ç™»å½•');
            response.data.msg = 'ç™»å½•è¶…æ—¶ï¼Œè¯·é‡æ–°ç™»å½•';
            return Promise.reject(response.data);
        }
        // ä¸ºäº†å…¼å®¹500ï¼Œå‰ç«¯æŠ¥é”™ï¼ˆæœ‰äº›åç«¯æ‰“æ­»ä¸ç»™æˆ‘200ï¼Œåªèƒ½è‡ªå·±æ‰‹åŠ¨å±è”½ï¼‰
        if (config.otherType) {
            if (parseInt(response.data.code) === 500) {
                if (config.otherType === 'upData') {
                    console.error(`å‰ç«¯é”™è¯¯ - ã€${config.name}ã€‘ ${config.url}`);
                    return Promise.reject(response.data);
                }
            }
        }
        if (response.status !== 200) {
            // æ¥å£æ²¡é€šï¼ˆæç¤ºï¼šç³»ç»Ÿé”™è¯¯, è¯·ç¨åå†è¯•ï¼‰
            let err = new Error(`æ²¡æœ‰è°ƒé€š -ã€${config.name}ã€‘ ${config.url}`);
            return Promise.reject(err);
        }
        if (!apiIsSuccess) {
            // ä¸æ˜¯å‰ç«¯çš„é”™è¯¯ï¼Œåç«¯é”™è¯¯ï¼ˆæç¤ºï¼šç³»ç»Ÿé”™è¯¯, è¯·ç¨åå†è¯•ï¼‰
            let err = new Error(`åç«¯é”™è¯¯ - ã€${config.name}ã€‘ ${config.url}`);
            return Promise.reject(err);
        }
        if (!returnDataSuccess) {
            // å‰ç«¯é”™è¯¯å¯¼è‡´çš„å¼‚å¸¸æµï¼ˆæç¤ºtoast:errorï¼‰
            console.error(`å‰ç«¯é”™è¯¯ - ã€${config.name}ã€‘ ${config.url}`);
            return Promise.reject(response.data);
        } else {
            // æ­£ç¡®çš„ï¼ˆè¿”å›ï¼šæ¥å—åˆ°çš„å†…å®¹data.dataï¼‰
            return Promise.resolve(response.data.data);
        }
    };

    const request = function (config) {
        return instance({
            ...config
        })
        .then(response => Promise.resolve({config, response}))
        .then(resolveResponse)
        .catch((err) => {
            if (err instanceof Error) {
                // åç«¯ä¸å½“
                console.error(err);
                Toast.show({ info: 'è¯·æ±‚å¤±è´¥, è¯·ç¨åå†è¯•', duration: 2000});
            } else {
                // å‰ç«¯ä¸å½“ï¼ˆæœ‰äºŒç»´ç traceIdæç¤ºï¼‰
                Toast.show({ info: err.msg, duration: 2000, traceId: err.traceId });
            }
            // æ­£å¸¸
            return Promise.reject(err);
        });
    };
```

> ä¸Šé¢çš„ä»£ç æ¥è‡ªï¼š
[é”€å”®è®¢å•é¡¹ç›®ä¸­çš„è·¯ç”±æ‹¦æˆªå™¨å®ä¾‹åœ°å€ğŸ”—](https://git.souche-inc.com/guanghui/frontend/new-pc-order-management/blob/master/src/api/_instance.js)

## 2âƒ£ï¸ æ¥å£è¯·æ±‚å¼‚å¸¸å¤„ç†

### 2.1 è¯·æ±‚è¶…æ—¶

> é€šå¸¸æƒ…å†µä¸‹å½“æ¥å£è¯·æ±‚è¶…æ—¶äº†ï¼Œå°±ä¼šæŠ¥é”™ã€‚</br>
> ä½†æ˜¯ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡axiosçš„responseæ‹¦æˆªå™¨ï¼Œé‡æ–°è¯·æ±‚å¤±è´¥çš„æ¥å£å¤šæ¬¡ã€‚

``` js
    axios.defaults.retry = 4; // è¯·æ±‚æ¬¡æ•°
    axios.defaults.retryDelay = 1000; // è¯·æ±‚çš„é—´éš™

    axios.interceptors.response.use(
        // æ­£å¸¸
        undefined,
        // å¼‚å¸¸
        function axiosRetryInterceptor(err) {
            var config = err.config;
            // å‡ºç°ä»¥ä¸‹ä¸é‡æ–°è¯·æ±‚æ¥å£ï¼š
            //      1. err ä¸­æ— config
            //      2. æ²¡æœ‰è®¾ç½®æœ€å¤šé‡å¤è¯·æ±‚è¶…æ—¶æ¥å£å‡ æ¬¡
            if(!config || !config.retry) return Promise.reject(err);

            // åˆå§‹åŒ–å½“å‰æ˜¯ç¬¬å‡ æ¬¡è¯·æ±‚
            config.__retryCount = config.__retryCount || 0;

            // æ£€æŸ¥æ˜¯å¦å·²ç»æ˜¯æœ€å¤§æ¬¡è¯·æ±‚äº†
            if(config.__retryCount >= config.retry) {
                // Reject with the error
                return Promise.reject(err);
            }

            // è®¾ç½®å½“å‰æ˜¯é‡æ–°è¯·æ±‚çš„ç¬¬å‡ æ¬¡
            config.__retryCount += 1;

            // é—´éš”ä¸€æ®µæ—¶é—´å†è¯·æ±‚æ¥å£
            var backoff = new Promise(function(resolve) {
                setTimeout(function() {
                    resolve();
                }, config.retryDelay || 1);
            });

            // ç”¨ä¹‹å‰çš„configå†æ¬¡è¯·æ±‚æ¥å£
            return backoff.then(function() {
                return axios(config);
            });
        }
    );
```